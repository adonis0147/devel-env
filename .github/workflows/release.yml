name: Release

on:
  push:
    tags:
      - '*'

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build
        run: |
          cd toolchain
          docker build --platform=linux/x86-64 -t toolchain .
          mkdir output
          docker run --platform=linux/x86-64 --rm --mount type=bind,source="$(pwd)/output",target=/output toolchain

      - name: Upload
        uses: actions/upload-artifact@v3
        with:
          name: toolchain
          path: toolchain/output/install_toolchain.sh

  Publish:
    runs-on: ubuntu-latest
    needs: [build]
    env:
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download
        uses: actions/download-artifact@v3
        with:
          name: toolchain
          path: output

      - name: Release
        run: |
          tag_name="${{ github.ref }}"
          tag_name="${tag_name#refs/tags/}"

          md5="$(md5sum output/install_toolchain.sh | awk '{print $1}')"
          sha256="$(sha256sum output/install_toolchain.sh | awk '{print $1}')"
          cat .github/templates/release.md | sed "s/MD5_CHECKSUMS/${md5}/;s/SHA256_CHECKSUMS/${sha256}/" >release.md

          gh release create -t "devel-env ${tag_name}" "${tag_name}" -F release.md output/install_toolchain.sh
